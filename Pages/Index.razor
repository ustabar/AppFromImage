@page "/"
@using EShopApp.Models
@using EShopApp.Services
@inject ProductService ProductService
@inject CartService CartService
@inject AuthService AuthService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@implements IDisposable

<div class="hero-section">
    <div class="hero-content">
        <div class="logo">
            <img src="/images/logo.svg" alt="Northern Mountains" />
        </div>
        <div class="user-section">
            @if (AuthService.IsLoggedIn)
            {
                <span class="welcome-message">Welcome @AuthService.CurrentUser</span>
            }
            
            <div class="user-actions">
                @if (AuthService.IsLoggedIn)
                {
                    <span class="logout-icon" @onclick="Logout" title="Logout">ðŸšª</span>
                }
                else
                {
                    <span class="user-icon" @onclick="NavigateToLogin" title="Login">ðŸ‘¤</span>
                }
                <span class="cart-icon" @onclick="NavigateToCart" title="Shopping Cart">
                    ðŸ›’
                    @if (cartItemCount > 0)
                    {
                        <span class="cart-badge">@cartItemCount</span>
                    }
                </span>
            </div>
        </div>
    </div>
    
    <div class="hero-text">
        <h1>Ready for a new adventure?</h1>
        <p>Start the season with the latest in clothing and equipment.</p>
    </div>
</div>



<div class="main-content">
    <div class="products-grid">
        @foreach (var product in filteredProducts)
        {
            <div class="product-card">
                <img src="@product.ImageUrl" alt="@product.Name" />
                <h4>@product.Name</h4>
                <p class="brand">@product.Brand</p>
                <p class="price">$@product.Price.ToString("F2")</p>
                <button class="btn btn-primary" @onclick="() => AddToCart(product)">Add to Cart</button>
            </div>
        }
    </div>
</div>

@code {
    private List<Product> products = new();
    private List<Product> filteredProducts = new();
    private List<string> brands = new();
    private List<string> types = new();
    
    private int cartItemCount = 0;
    
    private string selectedBrand = "All";
    private string selectedType = "All";
    private bool showFilters = false;

    protected override void OnInitialized()
    {
        products = ProductService.GetProducts();
        filteredProducts = products;
        brands = ProductService.GetBrands();
        types = ProductService.GetTypes();
        
        CartService.CartChanged += OnCartChanged;
        AuthService.AuthStateChanged += OnAuthStateChanged;
        
        cartItemCount = CartService.GetCartItemCount();
    }

    private void OnCartChanged()
    {
        cartItemCount = CartService.GetCartItemCount();
        InvokeAsync(StateHasChanged);
    }

    private void OnAuthStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private void NavigateToLogin()
    {
        Navigation.NavigateTo("/login");
    }

    private async Task Logout()
    {
        await AuthService.LogoutAsync();
    }

    private void AddToCart(Product product)
    {
        CartService.AddToCart(product);
    }

    private void NavigateToCart()
    {
        Navigation.NavigateTo("/cart");
    }

    private void ToggleFilters()
    {
        showFilters = !showFilters;
    }

    public void Dispose()
    {
        CartService.CartChanged -= OnCartChanged;
        AuthService.AuthStateChanged -= OnAuthStateChanged;
    }
}